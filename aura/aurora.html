<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aurora - Assistente de Suporte Emocional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="icon" type="image/x-icon" href="img/logo-janela.png">
    <style>
        /* ‚ö†Ô∏è CORRE√á√ÉO: CSS personalizado para a cor bege exata */
        body {
            background-color: #F7F4F0; /* Cor bege/creme da imagem */
        }
        
        /* Anima√ß√µes personalizadas */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #4b5563;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 500ms; }
        .typing-dot:nth-child(3) { animation-delay: 1000ms; }
        
        /* Altura do container do chat */
        .chat-container {
            height: calc(100vh - 150px);
        }
        
        /* Barra de rolagem personalizada */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        /* Anima√ß√£o de deslizar para dentro do menu */
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .slide-in {
            animation: slideIn 0.3s forwards;
        }

        /* Bot√£o de voz (fixo) */
        .voice-btn-active { background-color: #dc2626 !important; } /* vermelho quando ouvindo */
    </style>
</head>
<body class="font-sans"> 
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button
                  id="menuButton"
                  class="text-gray-700 hover:text-green-600 focus:outline-none"
                >
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center space-x-2">
                    <img
                      src="img/logo-janela.png"
                      alt="Logo da Aurora"
                      class="h-8 w-8 rounded-full"
                      onerror="this.src='https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/34cc0767-6809-4282-86a6-755ed20e77c3.png'"
                    />
                    <h1 class="text-xl font-semibold text-gray-800">Aurora</h1>
                </div>
                
                <button
                  id="profileButton"
                  class="text-gray-700 hover:text-green-600 focus:outline-none"
                >
                    <i class="fas fa-user-circle text-xl"></i>
                </button>
            </div>
        </header>
        
        <div
          id="sideMenu"
          class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full z-20 p-4 overflow-y-auto"
        >
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800">Hist√≥rico do Chat</h2>
                <button id="closeMenu" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyList" class="space-y-2">
                </div>
        </div>
        
        <div
          id="profileModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 hidden"
        >
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Seu Perfil</h3>
                    <button id="closeProfile" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex flex-col items-center mb-4">
                
                </div>
                <div class="space-y-3">
                    <a href="Configuracoes.html">
                    <button
                      class="w-full py-2 px-4 bg-gray-100 hover:bg-gray-200 rounded-lg text-left"
                    >
                        <i class="fas fa-cog mr-2"></i> Configura√ß√µes
                    </button>
                    </a>

                    <a href="home.html">
                    <button
                      class="w-full py-2 px-4 bg-red-50 hover:bg-red-100 rounded-lg text-left text-red-600"
                      id="logoutBtn"
                    >
                        <i class="fas fa-sign-out-alt mr-2"></i> Sair
                    </button>
                    </a>
                </div>
            </div>
        </div>
        
        <main class="flex-1 container mx-auto px-4 py-4 flex flex-col">
            <div
              id="chatMessages"
              class="chat-messages flex-1 overflow-y-auto mb-4 space-y-4"
            >
                <div class="flex justify-start">
                    <div
                      class="max-w-3/4 bg-green-100 rounded-2xl p-4 text-green-900"
                    >
                        <div class="flex items-center mb-2">
                            <img
                              src="img/avatar.png"
                              alt="Avatar da Aurora"
                              class="h-8 w-8 rounded-full mr-2"
                              onerror="this.src='https://placehold.co/32x32/DDEEFF/CCDDFF?text=A'"
                            />
                            <span class="font-semibold">Aurora</span>
                        </div>
                        <p>
                            Ol√°! Eu sou a Aurora, sua assistente de suporte emocional.
                            Estou aqui para ouvir voc√™ e ajudar a navegar seus sentimentos.
                        </p>
                        <p class="mt-2">Como voc√™ est√° se sentindo hoje?</p>

                        <div class="flex flex-wrap gap-2 mt-3">
                            <button
                              class="quick-response-btn px-3 py-1 bg-white rounded-full text-sm border border-green-200 hover:bg-green-50"
                            >
                                Estou me sentindo um pouco ansioso(a)
                            </button>
                            <button
                              class="quick-response-btn px-3 py-1 bg-white rounded-full text-sm border border-green-200 hover:bg-green-50"
                            >
                                Estou estressado(a) com o trabalho
                            </button>
                            <button
                              class="quick-response-btn px-3 py-1 bg-white rounded-full text-sm border border-green-200 hover:bg-green-50"
                            >
                                Estou me sentindo sozinho(a)
                            </button>
                            <button
                              class="quick-response-btn px-3 py-1 bg-white rounded-full text-sm border border-green-200 hover:bg-green-50"
                            >
                                S√≥ preciso conversar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div
              id="emergencyBanner"
              class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4"
            >
                <div class="flex items-start">
                    <div class="text-red-500 mr-3 mt-1">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-red-800">Recursos Importantes</h4>
                        <p class="text-red-700 text-sm mt-1">
                            Se voc√™ est√° passando por grande ang√∫stia ou pensamentos
                            de automutila√ß√£o, por favor, entre em contato com o
                            <a
                              href="https://www.cvv.org.br/"
                              class="font-semibold underline"
                              target="_blank"
                              >Centro de Valoriza√ß√£o da Vida (CVV)</a
                            >
                            ou os servi√ßos de emerg√™ncia locais.
                        </p>
                    </div>
                </div>
            </div>
            
            <div
              class="bg-white rounded-lg shadow-sm border border-gray-200 p-3"
            >
                <div class="flex items-center">
                    <textarea
                      id="messageInput"
                      class="flex-1 border-0 focus:ring-0 resize-none py-2 px-3 text-gray-700 placeholder-gray-400 focus:outline-none"
                      rows="1"
                      placeholder="Digite sua mensagem..."
                      style="min-height: 40px"
                    ></textarea>
                    <button
                      id="sendButton"
                      class="ml-3 bg-green-600 hover:bg-green-700 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center"
                        onclick="sendMessage()"                    
                      >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="flex justify-end mt-1">
                    <button
                      id="emergencyButton"
                      class="text-xs text-red-600 hover:text-red-800 flex items-center"
                    >
                        <i class="fas fa-exclamation-triangle mr-1"></i> Preciso de ajuda urgente
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div class="fixed bottom-24 right-6">
        <button id="voiceToggle"
            title="Ativar / Desativar voz"
            class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Garante que a lista de vozes seja populada ao carregar a p√°gina
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log("Vozes do TTS carregadas.");
                };
            }
            
            // === CONFIGURA AQUI ===
            const API_BASE = 'https://aurora-api-quwn.onrender.com';
            const MESSAGE_ENDPOINT = API_BASE + '/api/message'; // rota correta para enviar mensagem

            // Elementos do DOM
            const menuButton = document.getElementById('menuButton');
            const closeMenu = document.getElementById('closeMenu');
            const sideMenu = document.getElementById('sideMenu');
            const profileButton = document.getElementById('profileButton');
            const profileModal = document.getElementById('profileModal');
            const closeProfile = document.getElementById('closeProfile');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const emergencyButton = document.getElementById('emergencyButton');
            const emergencyBanner = document.getElementById('emergencyBanner');
            const quickResponseButtons = document.querySelectorAll('.quick-response-btn');
            const historyList = document.getElementById('historyList');
            const logoutBtn = document.getElementById('logoutBtn');
            const voiceButton = document.getElementById('voiceToggle');

            // Estado do reconhecimento
            let recognition = null;
            let recognizing = false;
            let auroraAwake = false; // quando true, a fala do usu√°rio √© enviada como mensagem
            let lastTranscript = "";

            // Menu
            menuButton.addEventListener('click', () => {
                sideMenu.classList.add('slide-in');
                sideMenu.classList.remove('hidden');
            });
            closeMenu && closeMenu.addEventListener('click', () => sideMenu.classList.add('hidden'));
            profileButton.addEventListener('click', () => profileModal.classList.remove('hidden'));
            closeProfile && closeProfile.addEventListener('click', () => profileModal.classList.add('hidden'));
            window.addEventListener('click', (event) => {
                if (event.target === profileModal) profileModal.classList.add('hidden');
                if (event.target === sideMenu) sideMenu.classList.add('hidden');
            });
            logoutBtn && logoutBtn.addEventListener('click', () => {
                profileModal.classList.add('hidden');
                historyList.innerHTML = '';
                addLocalHistory({ user: 'Usu√°rio saiu da sess√£o', bot: '' });
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Send message (main)
            async function sendMessage() {
                const content = messageInput.value.trim();
                if (!content) return;

                const userId = "12345";

                // adiciona mensagem do usu√°rio
                addMessageToChat('user', content);
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // mostra indicador de digita√ß√£o
                showTypingIndicator();
                setSendingState(true);

                // tenta enviar para a API
                try {
                    const res = await fetch(MESSAGE_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId,
                            content
                        })
                    });

                    if (!res.ok) {
                        console.warn('API respondeu com status', res.status);
                        const textFallback = (await res.text()) || 'Erro no servidor';
                        hideTypingIndicator();
                        addMessageToChat('assistant', `Desculpe, ocorreu um erro no servidor: ${textFallback}`);
                        addLocalHistory({ user: content, bot: `Erro: ${res.status}` });
                        return;
                    }

                    const data = await res.json();

                    // Mapeia poss√≠veis formatos de resposta do backend
                    const botText = data.resposta || data.reply || data.message || data.text || (data.result && data.result.reply) || JSON.stringify(data);
                    const isEmergency = data.isEmergency || data.emergency || false;

                    const respostaLimpa = limparFormato(botText);

                    hideTypingIndicator();
                    addMessageToChat('assistant', respostaLimpa, isEmergency);

                    // salva no hist√≥rico local (simples)
                    addLocalHistory({ user: content, bot: respostaLimpa });
                } catch (err) {
                    console.error('Erro ao conectar com a API:', err);
                    hideTypingIndicator();
                    const local = generateResponse(content);
                    addMessageToChat('assistant', local.message, local.isEmergency);
                    addLocalHistory({ user: content, bot: local.message + ' (gerado localmente)' });
                } finally {
                    setSendingState(false);
                }
            }

            // Bind send
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Quick responses
            quickResponseButtons.forEach((button) => {
                button.addEventListener('click', function () {
                    const text = this.textContent.trim();
                    messageInput.value = text;
                    sendMessage();
                });
            });

            // Emergency button
            emergencyButton.addEventListener('click', function () {
                emergencyBanner.classList.remove('hidden');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                setTimeout(() => emergencyBanner.scrollIntoView({ behavior: 'smooth' }), 100);
            });

            // UI helpers
            function addMessageToChat(sender, message, isEmergency = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

                let messageContent = `
                    <div class="max-w-3/4 rounded-2xl p-4 ${sender === 'user' ? 'bg-gray-300 text-gray-900' : 'bg-green-100 text-green-900'}">
                `;

                if (sender === 'assistant') {
                    messageContent += `
                        <div class="flex items-center mb-2">
                            <img src="avatar.png" alt="Aurora" class="h-8 w-8 rounded-full mr-2" onerror="this.src='https://placehold.co/32x32/DDEEFF/CCDDFF?text=A'"/>
                            <span class="font-semibold">Aurora</span>
                        </div>
                    `;
                }

                messageContent += `<p>${message}</p>`;


                if (isEmergency) {
                    messageContent += `
                        <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-sm text-red-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Com base no que voc√™ compartilhou, recomendo contatar o <a href="https://www.cvv.org.br/" class="font-semibold underline" target="_blank">CVV</a> para suporte imediato.
                            </p>
                        </div>
                    `;
                }

                messageContent += '</div>';
                messageDiv.innerHTML = messageContent;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // typing indicator
            function showTypingIndicator() {
                if (document.getElementById('typingIndicator')) return;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex justify-start mb-4';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="bg-indigo-100 rounded-2xl p-4 text-gray-800 max-w-xs">
                        <div class="flex items-center">
                            <img src="avatar.png" alt="Aurora" class="h-8 w-8 rounded-full mr-2" onerror="this.src='https://placehold.co/32x32/DDEEFF/CCDDFF?text=A'">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
            }

            // controla bot√£o/enviar durante envio
            function setSendingState(isSending) {
                sendButton.disabled = isSending;
                sendButton.style.opacity = isSending ? '0.6' : '1';
            }

            // Hist√≥rico simples (localStorage)
            function addLocalHistory(entry) {
                try {
                    const key = 'aurora_history';
                    const cur = JSON.parse(localStorage.getItem(key) || '[]');
                    cur.push({ ...entry, ts: new Date().toISOString() });
                    localStorage.setItem(key, JSON.stringify(cur));
                    renderHistory();
                } catch (err) { console.warn('Erro ao salvar hist√≥rico', err); }
            }
            function renderHistory() {
                const key = 'aurora_history';
                const cur = JSON.parse(localStorage.getItem(key) || '[]');
                historyList.innerHTML = '';
                cur.slice().reverse().forEach(h => {
                    const el = document.createElement('div');
                    el.className = 'p-3 rounded-lg hover:bg-gray-100 text-gray-700';
                    el.innerHTML = `<div class="text-sm text-gray-600">${new Date(h.ts).toLocaleString()}</div>
                                    <div class="font-medium">${escapeHtml(String(h.user || ''))}</div>
                                    <div class="text-sm text-gray-600 mt-1">${escapeHtml(String(h.bot || ''))}</div>`;
                    historyList.appendChild(el);
                });
            }
            renderHistory();

            // pequeno sanitizador para evitar inje√ß√£o de HTML no chat
            function escapeHtml(unsafe) {
                return String(unsafe)
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
            }

            // Limpa formata√ß√µes indesejadas de Markdown/aspas
            function limparFormato(texto) {
                if (!texto) return "";
                return String(texto)
                    .replace(/\*\*(.*?)\*\*/g, "$1")   // **bold**
                    .replace(/\*(.*?)\*/g, "$1")       // *italic*
                    .replace(/_(.*?)_/g, "$1")         // _italic_
                    .replace(/`+/g, "")                // `code`
                    .replace(/"{2,}/g, "")             // aspas duplas repetidas
                    .replace(/^"|"$/g, "")             // aspas soltas no come√ßo/fim
                    .replace(/\s+/g, " ")
                    .trim();
            }

            // === Fallback local: usa a l√≥gica que voc√™ j√° tinha ===
            function generateResponse(userMessage) {
                const lowerMsg = userMessage.toLowerCase();
                const emergencyPhrases = ['suic√≠dio', 'me matar', 'acabar com minha vida', 'sem esperan√ßa', 'sem sa√≠da', 'emerg√™ncia'];
                const empatheticResponses = [
                    "Eu te escuto. √â preciso coragem para compartilhar o que est√° sentindo. Pode me contar mais sobre o que est√° passando pela sua cabe√ßa?",
                    "Estou aqui para voc√™. O que voc√™ est√° vivendo parece muito dif√≠cil. Ajudaria conversar sobre isso?",
                    "O que voc√™ est√° sentindo √© totalmente v√°lido. Vamos explorar algumas formas de voc√™ se sentir melhor.",
                    "Eu entendo que isso √© dif√≠cil para voc√™. Lembre-se que seus sentimentos importam e que ajuda est√° dispon√≠vel."
                ];
                const copingStrategies = [
                    "Exerc√≠cios de respira√ß√£o podem ajudar. Tente inspirar por 4 segundos, segurar por 4, e expirar por 6.",
                    "√Äs vezes, dar um passo para tr√°s e fazer uma caminhada r√°pida pode ajudar a clarear a mente.",
                    "Escrever seus pensamentos pode ajudar a organiz√°-los e reduzir sua intensidade."
                ];
                const professionalSuggestions = [
                    "Pode ser √∫til conversar com um profissional sobre isso. Gostaria de orienta√ß√µes para encontrar ajuda?",
                    "Existem conselheiros e terapeutas que s√£o especializados nesses tipos de situa√ß√£o."
                ];
                const containsEmergency = emergencyPhrases.some(phrase => lowerMsg.includes(phrase));
                if (containsEmergency) {
                    return {
                        message: "Estou profundamente preocupado com o que voc√™ est√° me dizendo. Sua seguran√ßa √© a coisa mais importante agora. Por favor, fique comigo e saiba que ajuda est√° dispon√≠vel.",
                        isEmergency: true
                    };
                }
                if (lowerMsg.includes('triste') || lowerMsg.includes('deprimido') || lowerMsg.includes('ansioso')) {
                    return {
                        message: `${empatheticResponses[Math.floor(Math.random() * empatheticResponses.length)]} ${professionalSuggestions[Math.floor(Math.random() * professionalSuggestions.length)]} ${copingStrategies[Math.floor(Math.random() * copingStrategies.length)]}`,
                        isEmergency: false
                    };
                }
                if (lowerMsg.includes('estresse') || lowerMsg.includes('sobrecarregado')) {
                    return {
                        message: `${empatheticResponses[Math.floor(Math.random() * empatheticResponses.length)]} Quando voc√™ se sentir sobrecarregado, ${copingStrategies[Math.floor(Math.random() * copingStrategies.length)]}`,
                        isEmergency: false
                    };
                }
                return {
                    message: "Obrigado por compartilhar isso comigo. Estou aqui para ouvir e apoiar voc√™ no que precisar. Gostaria de me contar mais sobre como est√° se sentindo?",
                    isEmergency: false
                };
            }

            // ========== RECONHECIMENTO DE VOZ (Web Speech API) ==========
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;

            if (SpeechRec) {
                recognition = new SpeechRec();
                recognition.lang = "pt-BR";
                recognition.continuous = true;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    recognizing = true;
                    voiceButton.classList.add('voice-btn-active');
                    console.log('Reconhecimento de voz iniciado');
                };

                // ‚ö†Ô∏è CORRE√á√ÉO DE ESTABILIDADE DO MICROFONE APLICADA AQUI
                recognition.onend = () => {
                    recognizing = false;
                    voiceButton.classList.remove('voice-btn-active');
                    console.log('Reconhecimento de voz parado');

                    // Se Aurora foi desativada manualmente (auroraAwake = false), o ciclo √© encerrado.
                    if (!auroraAwake) {
                        return;
                    }
                    
                    // Se foi parado automaticamente (oscilando no Vercel), reinicia com um pequeno atraso para estabilizar.
                    console.log('Reconhecimento de voz parado, reiniciando automaticamente...');
                    
                    setTimeout(() => { 
                        try {
                            recognition.start();
                        } catch (e) {
                            console.warn('Erro ao reiniciar reconhecimento:', e);
                        }
                    }, 200); // Atraso de 200ms para evitar oscila√ß√£o r√°pida
                };

                recognition.onerror = (ev) => {
                    console.warn('Erro no reconhecimento de voz:', ev.error);
                };

                recognition.onresult = async (event) => {
                    console.log("üöÄ EVENTO DE FALA DISPAROU");
                    const lastIndex = event.results.length - 1;
                    const transcriptRaw = event.results[lastIndex][0].transcript || '';
                    const transcript = transcriptRaw.toLowerCase().trim();
                    console.log("üé§ Texto capturado (bruto):", transcriptRaw);
                    console.log("üé§ Texto capturado (normalizado):", transcript);

                    lastTranscript = transcript;

                    // ATIVA√á√ÉO por fala ‚Äî flex√≠vel (v√°rias formas)
                    if (!auroraAwake && (
                        transcript.includes("ol√° aurora") ||
                        transcript.includes("ola aurora") ||
                        transcript.includes("oi aurora") ||
                        transcript === "aurora" ||
                        transcript.includes("aurora,") ||
                        transcript.includes("aurora ")
                    )) {
                        auroraAwake = true;
                        speak("Ol√°! Estou aqui. Pode falar comigo.");
                        console.log('Aurora ativada por voz');
                        return; // n√£o enviar essa frase como mensagem
                    }

                    // DESATIVA√á√ÉO por fala
                    if (auroraAwake && (
                        transcript.includes("aurora parar") ||
                        transcript.includes("parar aurora") ||
                        transcript.includes("sil√™ncio aurora") ||
                        transcript.includes("silencio aurora") ||
                        transcript.includes("pare aurora")
                    )) {
                        auroraAwake = false;
                        speak("Tudo bem, vou ficar em sil√™ncio.");
                        console.log('Aurora desativada por voz');
                        return;
                    }

                    // Se Aurora estiver awake, enviar para API
                    if (auroraAwake && transcript.length > 0) {
                        // evitar reenvio do mesmo transcript repetidamente
                        console.log("üì® Enviando para API (via voz):", transcript);
                        addMessageToChat('user', transcript);

                        showTypingIndicator();
                        setSendingState(true);
                        try {
                            const botRaw = await sendVoiceMessage(transcript);
                            const botClean = limparFormato(botRaw);

                            hideTypingIndicator();
                            addMessageToChat('assistant', botClean);
                            addLocalHistory({ user: transcript, bot: botClean });

                            console.log("üì© Resposta da API (via voz):", botClean);
                            speak(botClean);
                        } catch (err) {
                            hideTypingIndicator();
                            console.error('Erro em sendVoiceMessage:', err);
                            const local = generateResponse(transcript);
                            addMessageToChat('assistant', local.message, local.isEmergency);
                            addLocalHistory({ user: transcript, bot: local.message + ' (gerado localmente)' });
                            speak(local.message);
                        } finally {
                            setSendingState(false);
                        }
                    }
                };
            } else {
                console.warn("Reconhecimento de voz n√£o suportado neste navegador.");
            }

            // Fun√ß√£o para enviar mensagem em modo voz (usa mesma rota do envio normal)
            async function sendVoiceMessage(content) {
                // √∫til para debug: testa conex√£o
                const userId = "12345";
                const res = await fetch(MESSAGE_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, content })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Status ${res.status}: ${txt}`);
                }

                const data = await res.json();
                const botText = data.resposta || data.reply || data.message || data.text || (data.result && data.result.reply) || JSON.stringify(data);
                return botText;
            }

            // Bot√£o manual de ativar/desativar escuta
            voiceButton.addEventListener('click', () => {
                if (!recognizing) {
                    // start and set auroraAwake true
                    auroraAwake = true;
                    try {
                        recognition && recognition.start();
                        speak("Estou ouvindo voc√™.");
                    } catch (e) {
                        console.warn('Erro ao iniciar reconhecimento:', e);
                    }
                } else {
                    // stop and set auroraAwake false
                    auroraAwake = false;
                    try {
                        // O stop chama recognition.onend, que agora verifica !auroraAwake e n√£o reinicia.
                        recognition && recognition.stop();
                        speak("Certo. Vou parar de ouvir agora.");
                    } catch (e) {
                        console.warn('Erro ao parar reconhecimento:', e);
                    }
                }
            });

            // TTS: fala a resposta
            function speak(text) {
                if (!text) return;
                try {
                    // limpa texto antes de falar
                    const t = limparFormato(text);
                    const msg = new SpeechSynthesisUtterance(t);
                    msg.lang = "pt-BR";
                    msg.rate = 1;
                    msg.pitch = 1;

                    // L√ìGICA DE SELE√á√ÉO DE VOZ (PRIORIZANDO GOOGLE)
                    const voices = speechSynthesis.getVoices(); 
                    
                    // 1. Tenta encontrar a voz do Google em Portugu√™s
                    let femaleVoice = voices.find(
                        voice => voice.lang.startsWith("pt") && voice.name.toLowerCase().includes("google")
                    );
                    
                    // 2. Fallback: Se n√£o encontrar a voz do Google, procura por outros nomes femininos
                    if (!femaleVoice) {
                        const femaleKeywords = ["luciana", "isabella", "heloisa", "vitoria", "raquel", "celina", "ana", "female", "woman"];
                        const lcFemaleKeywords = femaleKeywords.map(k => k.toLowerCase());
                        
                        femaleVoice = voices.find(
                            voice => voice.lang.startsWith("pt") && lcFemaleKeywords.some(keyword => voice.name.toLowerCase().includes(keyword))
                        );
                    }
                    
                    // 3. Fallback final: Se ainda assim n√£o encontrar, usa a primeira voz pt-BR dispon√≠vel.
                    if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang.startsWith("pt"));
                    }
                    
                    if (femaleVoice) {
                        msg.voice = femaleVoice;
                        console.log("Voz selecionada (nome):", femaleVoice.name);
                    } else {
                        console.warn("Nenhuma voz em Portugu√™s encontrada. Usando voz padr√£o do navegador.");
                    }
                    // FIM DA L√ìGICA DE SELE√á√ÉO DE VOZ
                    
                    // quando falar, evitar sobreposi√ß√£o: cancela fala anterior
                    if (speechSynthesis.speaking) speechSynthesis.cancel();
                    speechSynthesis.speak(msg);
                } catch (e) {
                    console.warn('Erro no TTS:', e);
                }
            }

        });
    </script>
</body>
</html>
