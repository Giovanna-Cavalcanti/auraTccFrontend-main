<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humor - Aura</title>
  <link rel="icon" type="image/x-icon" href="img/logo-janela.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="sidebar-styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="mobile-responsive.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Vari√°veis para consist√™ncia (Opcional, mas recomendado) */
    :root {
      --bg-main: #F8F5EE;
      /* Fundo Creme/Bege */
      --green-sidebar: #73804F;
      /* Cor principal da Sidebar */
      --green-light: #6B7A5C;
      /* Texto/Hover Claro */
      --brown-dark: #5C4C3E;
      /* T√≠tulos/Texto Escuro */
      --btn-primary: #7B8A6F;
      /* Bot√£o principal */
      --box-bg: #FFFFFF;
    }

    /* Estilos Personalizados */
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-main);
      /* Garante que o corpo use 100% da altura para o app-container funcionar */
      height: 100vh;
      margin: 0;
      overflow: hidden;
      /* Controla o scroll dentro do app-container */
    }

    /* Container principal da aplica√ß√£o (Sidebar + Conte√∫do) */
    .app-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      background: var(--bg-main);
      overflow: hidden;
      box-sizing: border-box;
    }

    /* CONTAINER PRINCIPAL DO CONTE√öDO */
    .main-content-wrapper {
      flex-grow: 1;
      /* Ocupa o espa√ßo restante */
      overflow-y: auto;
      /* Permite scroll no conte√∫do principal */
      padding-top: 5rem;
      /* Espa√ßo para o header */
      position: relative;
    }

    .main-container {
      min-height: calc(100vh - 5rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    /* HEADER FIXO E BOT√ÉO DE MENU */
    /* O header foi removido/adaptado, o settings-btn √© o elemento fixo mais importante */

    /* Configura√ß√£o (CORRIGIDO: Agora usa o SVG do settings para herdar cor) */
    .settings-btn {
      position: absolute;
      top: 32px;
      right: 48px;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--brown-dark);
      /* Usa a cor escura do tema */
      opacity: 0.7;
      transition: opacity 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      /* Garante que fique acima do conte√∫do */
    }

    .settings-btn:hover {
      opacity: 1;
    }

    .settings-btn svg {
      color: var(--brown-dark);
      /* For√ßa a cor do SVG */
    }

    /* Estilo do Bot√£o Principal */
    .btn-primary {
      background-color: var(--btn-primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background-color: #6B7A5C;
      transform: translateY(-1px);
    }

    /* Estilos do Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(92, 76, 62, 0.5);
      /* Fundo escuro ajustado para o tema */
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background-color: var(--box-bg);
      padding: 3rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    .modal-title {
      color: var(--brown-dark);
      font-size: 1.75rem;
      /* Ajustado para ficar maior */
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    /* Estilos Emojis (Mood Selector) */
    .mood-selector-container {
      display: flex;
      justify-content: space-around;
      gap: 0.75rem;
      margin-top: 2rem;
      margin-bottom: 3rem;
    }

    .mood-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 0.75rem;
      border-radius: 1rem;
      transition: background-color 0.2s, transform 0.2s;
      width: 18%;
      min-width: 90px;
    }

    .mood-option:hover {
      background-color: #E3E8DB;
      transform: translateY(-2px);
    }

    .mood-option.selected {
      background-color: #D9D2BF;
      border: 2px solid var(--btn-primary);
    }

    .mood-emoji-svg {
      width: 50px;
      height: 50px;
      margin-bottom: 0.5rem;
    }

    .mood-label {
      font-size: 0.8rem;
      color: var(--green-light);
      text-align: center;
      font-weight: 500;
    }

    /* Estilos Confirma√ß√£o */
    .confirmation-icon-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: #E3E8DB;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 1.5rem;
    }

    .confirmation-icon {
      color: var(--btn-primary);
      width: 40px;
      height: 40px;
      stroke-width: 3;
    }

    .confirmation-message {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--brown-dark);
    }

    /* Estilos Gr√°fico/Hist√≥rico */
    .chart-card {
      background-color: var(--box-bg);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: #FDFCF8;
      border-radius: 0.5rem;
      border: 1px solid #E3E8DB;
    }

    /* Estilo para Emojis na Lista de Hist√≥rico */
    .history-emoji-container {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--brown-dark);
    }

    .history-emoji-container svg {
      width: 20px;
      height: 20px;
      min-width: 20px;
    }


    /* Anima√ß√µes */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body>

  <div class="app-container" role="main">
    <!-- Sidebar ((padronizei aqui) -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <a href="home.html">
          <img src="img/Logo.png" alt="Logo Aura" width="40" height="40" viewBox="0 0 40 40">
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="home.html" class="nav-item active" title="Home">
          <img src="img/icons-menu/home.png" alt="Home" width="28" height="28" viewBox="0 0 28 28">
        </a>
        <a href="banco.html" class="nav-item" title="Banco de Psic√≥logos">
          <img src="img/icons-menu/banco.png" alt="Banco de Psic√≥logos" width="28" height="28" viewBox="0 0 28 28">
        </a>
        <a href="metricas.html" class="nav-item" title="M√©tricas">
          <img src="img/icons-menu/metricas.png" alt="M√©tricas" width="28" height="28" viewBox="0 0 28 28">
        </a>
        <a href="comunidade.html" class="nav-item" title="Comunidade">
          <img src="img/icons-menu/comunidade.png" alt="Comunidade" width="28" height="28" viewBox="0 0 28 28">
        </a>
      </nav>
      <button class="sidebar-back" onclick="window.location.href='login.html'" alt="Sair">
        <img src="img/icons-menu/sair.png" alt="Sair" width="28" height="28">
      </button>
    </aside>

    <div class="main-content-wrapper">

      <a href="Configuracoes.html">
        <button id="settingsBtn" class="settings-btn" aria-label="Configura√ß√µes" title="Configura√ß√µes">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" width="24" height="24" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
          </svg>
        </button>
      </a>

      <div class="main-container w-full max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold mb-8 text-[--brown-dark] w-full text-center">Meu Di√°rio de Emo√ß√µes
        </h1>

        <div class="w-full flex justify-between items-center mb-8">
          <h2 class="text-2xl font-bold text-[--green-light]">Hist√≥rico de Humor</h2>
          <button id="btnOpenMoodModal" class="btn-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
              stroke-width="2" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Humor do Dia
          </button>
        </div>

        <div class="chart-card w-full">
          <h3 class="text-xl font-semibold mb-4 text-[--brown-dark]">Evolu√ß√£o Semanal</h3>
          <div style="height: 300px;">
            <canvas id="moodChart"></canvas>
          </div>
        </div>

        <div class="w-full">
          <h3 class="text-xl font-semibold mb-4 text-[--brown-dark]">Registros Di√°rios</h3>
          <div id="moodHistoryList" class="space-y-3">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="moodSelectModal" class="modal-overlay">
    <div class="modal-content">
      <button class="absolute top-4 right-4 text-[--green-light] hover:text-[--brown-dark]" id="btnCloseMoodSelectModal"
        aria-label="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
          class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h3 class="modal-title">Registrar emo√ß√£o</h3>
      <p class="text-center text-lg font-medium mb-8 text-[--brown-dark]">Como voc√™ se sente hoje?</p>

      <div class="mood-selector-container">
        <div class="mood-option" data-mood="Muito Feliz" data-value="5">
          <svg class="mood-emoji-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#FFD700" />
            <circle cx="8.5" cy="10" r="1.5" fill="#333" />
            <circle cx="15.5" cy="10" r="1.5" fill="#333" />
            <path d="M8 15.5C8 15.5 9 17.5 12 17.5C15 17.5 16 15.5 16 15.5" stroke="#333" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span class="mood-label">Muito Feliz</span>
        </div>
        <div class="mood-option" data-mood="Feliz" data-value="4">
          <svg class="mood-emoji-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#A3B18A" />
            <circle cx="8.5" cy="10" r="1.5" fill="#333" />
            <circle cx="15.5" cy="10" r="1.5" fill="#333" />
            <path d="M8 14.5C8 14.5 9 15.5 12 15.5C15 15.5 16 14.5 16 14.5" stroke="#333" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span class="mood-label">Feliz</span>
        </div>
        <div class="mood-option" data-mood="Neutro" data-value="3">
          <svg class="mood-emoji-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#A9A9A9" />
            <circle cx="8.5" cy="10" r="1.5" fill="#333" />
            <circle cx="15.5" cy="10" r="1.5" fill="#333" />
            <line x1="8" y1="15" x2="16" y2="15" stroke="#333" stroke-width="1.5" stroke-linecap="round" />
          </svg>
          <span class="mood-label">Neutro</span>
        </div>
        <div class="mood-option" data-mood="Triste" data-value="2">
          <svg class="mood-emoji-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#FF7F50" />
            <circle cx="8.5" cy="10" r="1.5" fill="#333" />
            <circle cx="15.5" cy="10" r="1.5" fill="#333" />
            <path d="M8 16.5C8 16.5 9 14.5 12 14.5C15 14.5 16 16.5 16 16.5" stroke="#333" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span class="mood-label">Triste</span>
        </div>
        <div class="mood-option" data-mood="Muito Triste" data-value="1">
          <svg class="mood-emoji-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#8A2BE2" />
            <circle cx="8.5" cy="10" r="1.5" fill="#333" />
            <circle cx="15.5" cy="10" r="1.5" fill="#333" />
            <path d="M8 16.5C8 16.5 9 14.5 12 14.5C15 14.5 16 16.5 16 16.5" stroke="#333" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
            <path d="M7 10L6.5 12M17 10L17.5 12" stroke="#333" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <span class="mood-label">Muito Triste</span>
        </div>
      </div>

      <button id="btnRegisterMood" class="btn-primary w-full opacity-50 cursor-not-allowed" disabled>
        Registrar
      </button>
    </div>
  </div>

  <div id="moodConfirmModal" class="modal-overlay">
    <div class="modal-content text-center">
      <button class="absolute top-4 right-4 text-[#6B7A5C] hover:text-[#5C4C3E]" id="btnCloseMoodConfirmModal"
        aria-label="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
          class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h3 class="modal-title mb-8">Registro Conclu√≠do</h3>
      <div class="confirmation-content">
        <div class="confirmation-icon-container">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            class="confirmation-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <p class="confirmation-message">Humor registrado!</p>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
      <button class="absolute top-4 right-4 text-[--green-light] hover:text-[--brown-dark]" id="btnCloseSettingsModal"
        aria-label="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
          class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h3 class="modal-title">Configura√ß√µes</h3>

      <div class="space-y-6">
        <div class="border-b pb-4 border-gray-200">
          <h4 class="text-lg font-semibold text-[--brown-dark] mb-2">Gerenciamento de Dados</h4>
          <p class="text-sm text-gray-600 mb-4">Esta a√ß√£o apagar√° todos os seus registros de humor
            permanentemente.</p>
          <button id="btnClearData"
            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
            Apagar Todos os Registros
          </button>
        </div>
        <a href="Configuracoes.html">
          <button id="btnClearData"
            class="w-full bg-green-600 hover:bg-grey-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
            Configura√ß√µes
          </button>
        </a>

      </div>
    </div>
  </div>


  <script>
    // ============================================
    // FUN√á√ïES DE BACKEND (DECLARADAS PRIMEIRO)
    // ============================================

    // --- Fun√ß√£o para obter o token ---
    function getToken() {
      return localStorage.getItem('token');
    }

    // --- Fun√ß√£o para obter o ID do paciente ---
    function getPacienteId() {
      const id = localStorage.getItem("pacienteId");
      if (!id) {
        alert("‚ö†Ô∏è ID do paciente n√£o encontrado. Fa√ßa login novamente.");
        throw new Error("Paciente ID n√£o encontrado no localStorage.");
      }
      return id;
    }

    // --- Fun√ß√£o para registrar humor ---
    async function registrarHumor(humorSelecionado) {
      try {
        // Garante que √© string e remove espa√ßos
        const humorStr = String(humorSelecionado).trim();

        if (!humorStr) {
          throw new Error('Humor vazio - cancelando envio.');
        }

        const pacienteId = getPacienteId();

        // Monta payload
        const dados = {
          pacienteId: pacienteId,
          humor: humorStr
        };

        console.log("üì§ [REGISTRO] Enviando payload:", dados);

        const headers = { 'Content-Type': 'application/json' };
        const token = getToken();
        if (token) headers['Authorization'] = `Bearer ${token}`;

        // Faz a requisi√ß√£o
        const response = await fetch('https://auratccbackend.onrender.com/api/humor', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(dados)
        });

        const text = await response.text();
        let resultado;

        try {
          resultado = text ? JSON.parse(text) : {};
        } catch (err) {
          resultado = { raw: text };
        }

        console.log("üì• [REGISTRO] Resposta do servidor:", resultado, "status:", response.status);

        if (response.ok) {
          console.log('‚úÖ Humor registrado com sucesso no backend!');
          mostrarHumorAtual(humorStr);
          return true;
        } else {
          const msg = resultado.message || resultado.error || JSON.stringify(resultado);
          console.error('‚ùå Erro do servidor:', msg);
          alert('‚ùå Erro ao registrar humor: ' + msg);
          return false;
        }

      } catch (error) {
        console.error('‚ùå Erro em registrarHumor:', error);
        alert('‚ùå Erro ao conectar com o servidor');
        return false;
      }
    }

    // --- Fun√ß√£o para carregar humores (CORRIGIDA - N√ÉO CHAMA MAIS AUTOMATICAMENTE) ---
    async function carregarHumores() {
      try {
        const pacienteId = getPacienteId();

        // IMPORTANTE: Verifica se seu backend tem um endpoint GET separado
        // Se n√£o tiver, comente esta fun√ß√£o ou ajuste o endpoint
        console.log("üìã Carregando hist√≥rico de humores...");

        const headers = { 'Content-Type': 'application/json' };
        const token = getToken();
        if (token) headers['Authorization'] = `Bearer ${token}`;

        // OP√á√ÉO 1: Se seu backend tem um endpoint GET /api/humor/:pacienteId
        const response = await fetch(`https://auratccbackend.onrender.com/api/humor/${pacienteId}`, {
          method: 'GET',
          headers: headers
        });

        // OP√á√ÉO 2: Se precisa usar POST, certifique-se que o backend diferencia
        // entre "registrar" e "buscar" de alguma forma (query param, endpoint diferente, etc)

        const text = await response.text();
        let humores;

        try {
          humores = text ? JSON.parse(text) : [];
        } catch (err) {
          console.warn('Resposta n√£o-JSON:', text);
          return;
        }

        console.log("üì• Humores recebidos:", humores);

        if (response.ok) {
          exibirHistoricoHumores(humores);
        }

      } catch (error) {
        console.error('‚ùå Erro ao carregar humores:', error);
      }
    }

    // --- Fun√ß√µes auxiliares ---
    function mostrarHumorAtual(humor) {
      const emojis = {
        "Muito Feliz": "üòÑ",
        "Feliz": "üòä",
        "Neutro": "üòê",
        "Triste": "üò¢",
        "Muito Triste": "üò≠"
      };
      console.log(`‚úÖ Humor registrado: ${emojis[humor] || 'üòä'} ${humor}`);
    }

    function exibirHistoricoHumores(humores) {
      console.log("üìä Total de registros:", humores.length);
    }

    // ============================================
    // C√ìDIGO PRINCIPAL DO DOM
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      console.log("üéØ P√°gina de humor carregada!");
      console.log("üë§ Paciente ID:", localStorage.getItem('pacienteId'));

      // --- Fun√ß√µes de Persist√™ncia Local ---
      function loadMoodData() {
        const storedData = localStorage.getItem('dailyMoods');
        try {
          return storedData ? JSON.parse(storedData) : {};
        } catch (e) {
          console.error("Erro ao carregar localStorage:", e);
          return {};
        }
      }

      function saveMoodData(data) {
        localStorage.setItem('dailyMoods', JSON.stringify(data));
      }

      // --- Vari√°veis de Estado ---
      let dailyMoods = loadMoodData();
      const today = new Date();
      const todayKey = today.toISOString().split('T')[0];
      let selectedMood = null;
      let selectedValue = null;
      let selectedEmoji = null;
      let moodChartInstance = null;

      const moodLabels = {
        5: "Muito Feliz",
        4: "Feliz",
        3: "Neutro",
        2: "Triste",
        1: "Muito Triste"
      };

      // --- Elementos do DOM ---
      const btnOpenMoodModal = document.getElementById('btnOpenMoodModal');
      const moodSelectModal = document.getElementById('moodSelectModal');
      const moodConfirmModal = document.getElementById('moodConfirmModal');
      const moodOptions = document.querySelectorAll('.mood-option');
      const btnRegisterMood = document.getElementById('btnRegisterMood');
      const moodHistoryList = document.getElementById('moodHistoryList');
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const btnClearData = document.getElementById('btnClearData');

      // --- Fun√ß√µes de Modal ---
      function openModal(modal) {
        modal.style.display = 'flex';
      }

      function closeModal(modal) {
        modal.style.display = 'none';
      }

      // --- Bot√µes de Fechar ---
      const closeButtons = document.querySelectorAll('[id^="btnCloseMood"], #btnCloseSettingsModal');
      closeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          closeModal(moodSelectModal);
          closeModal(moodConfirmModal);
          closeModal(settingsModal);
        });
      });

      // --- Bot√£o de Configura√ß√µes ---
      if (settingsBtn) {
        settingsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          openModal(settingsModal);
        });
      }

      // --- Fun√ß√µes de Renderiza√ß√£o ---
      function prepareChartData() {
        const chartLabels = [];
        const chartData = [];
        const dates = [];

        for (let i = 6; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          dates.push(d.toISOString().split('T')[0]);
        }

        dates.forEach(dateKey => {
          const moodEntry = dailyMoods[dateKey];
          const d = new Date(dateKey + 'T00:00:00');
          chartLabels.push(d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
          chartData.push(moodEntry ? moodEntry.value : 3);
        });

        return { labels: chartLabels, data: chartData };
      }

      function renderMoodChart() {
        const data = prepareChartData();
        const ctx = document.getElementById('moodChart').getContext('2d');

        if (moodChartInstance) {
          moodChartInstance.destroy();
        }

        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--btn-primary').trim();
        const secondaryColor = '#A3B18A';
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--brown-dark').trim();
        const gridColor = '#E3E8DB';

        moodChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'N√≠vel de Humor',
              data: data.data,
              backgroundColor: `${primaryColor}66`,
              borderColor: primaryColor,
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 6,
              pointBackgroundColor: secondaryColor,
              fill: true,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: 1,
                max: 5,
                ticks: {
                  callback: function (value) {
                    return moodLabels[value] || '';
                  },
                  stepSize: 1,
                  color: textColor,
                },
                grid: { color: gridColor }
              },
              x: {
                grid: { display: false },
                ticks: { color: textColor }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `Humor: ${moodLabels[context.parsed.y]}`;
                  }
                }
              }
            }
          }
        });
      }

      function renderMoodHistory() {
        moodHistoryList.innerHTML = '';
        const dateTextColor = '#6B7A5C';

        Object.keys(dailyMoods)
          .sort((a, b) => new Date(b) - new Date(a))
          .forEach(dateKey => {
            const moodEntry = dailyMoods[dateKey];
            const dateFormatted = new Date(dateKey + 'T00:00:00').toLocaleDateString('pt-BR', {
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            });

            const li = document.createElement('div');
            li.className = 'history-item';
            li.innerHTML = `
          <span class="text-sm font-medium" style="color: ${dateTextColor};">${dateFormatted}</span>
          <div class="history-emoji-container">
            ${moodEntry.emoji} <span>${moodEntry.mood}</span>
          </div>
        `;
            moodHistoryList.appendChild(li);
          });
      }

      function openMoodSelectModal() {
        selectedMood = null;
        selectedValue = null;
        selectedEmoji = null;
        btnRegisterMood.disabled = true;
        btnRegisterMood.classList.add('opacity-50', 'cursor-not-allowed');
        moodOptions.forEach(o => o.classList.remove('selected'));

        const currentMood = dailyMoods[todayKey];
        let confirmation = true;

        if (currentMood) {
          confirmation = confirm(`Voc√™ j√° registrou o humor de hoje (${currentMood.mood}). Deseja alterar?`);

          if (confirmation) {
            const currentOption = document.querySelector(`.mood-option[data-mood="${currentMood.mood}"]`);
            if (currentOption) {
              currentOption.classList.add('selected');
              selectedMood = currentMood.mood;
              selectedValue = currentMood.value;
              selectedEmoji = currentOption.querySelector('.mood-emoji-svg').outerHTML;
              btnRegisterMood.disabled = false;
              btnRegisterMood.classList.remove('opacity-50', 'cursor-not-allowed');
            }
          }
        }

        if (confirmation) {
          openModal(moodSelectModal);
        }
      }

      function clearMoodData() {
        if (confirm("Tem certeza que deseja apagar TODOS os seus registros de humor? Esta a√ß√£o √© irrevers√≠vel.")) {
          dailyMoods = {};
          saveMoodData(dailyMoods);
          renderMoodChart();
          renderMoodHistory();
          closeModal(settingsModal);
          alert("Todos os registros de humor foram apagados com sucesso!");
        }
      }

      // --- Event Listeners ---

      // 1. Abrir Modal
      btnOpenMoodModal.addEventListener('click', openMoodSelectModal);

      // 2. Sele√ß√£o de Humor
      moodOptions.forEach(option => {
        option.addEventListener('click', () => {
          moodOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');

          selectedMood = option.getAttribute('data-mood');
          selectedValue = parseInt(option.getAttribute('data-value'));
          selectedEmoji = option.querySelector('.mood-emoji-svg').outerHTML;

          btnRegisterMood.disabled = false;
          btnRegisterMood.classList.remove('opacity-50', 'cursor-not-allowed');
        });
      });

      // 3. Registro de Humor (CORRIGIDO - SEM CARREGAR HUMORES DEPOIS)
      btnRegisterMood.addEventListener('click', async () => {
        if (!selectedMood) {
          console.error('‚ùå Nenhum humor selecionado!');
          return;
        }

        const moodToSend = String(selectedMood).trim();
        console.log('üéØ Humor selecionado para envio:', moodToSend);

        // Salva localmente
        dailyMoods[todayKey] = {
          mood: moodToSend,
          emoji: selectedEmoji,
          value: selectedValue
        };
        saveMoodData(dailyMoods);

        // Fecha modal e mostra confirma√ß√£o
        closeModal(moodSelectModal);
        openModal(moodConfirmModal);

        // Atualiza UI local
        renderMoodChart();
        renderMoodHistory();

        // Envia para o backend
        try {
          const success = await registrarHumor(moodToSend);
          if (success) {
            console.log("‚úÖ Humor sincronizado com sucesso!");
            // N√ÉO chama carregarHumores() aqui para evitar sobrescrever!
          }
        } catch (err) {
          console.error("‚ùå Erro ao sincronizar:", err);
          alert("Registro salvo localmente, mas houve erro ao sincronizar com o servidor.");
        }

        // Fecha confirma√ß√£o
        setTimeout(() => {
          closeModal(moodConfirmModal);
        }, 2000);
      });

      // 4. Limpar Dados
      btnClearData.addEventListener('click', clearMoodData);

      // --- Inicializa√ß√£o ---
      renderMoodChart();
      renderMoodHistory();

      // REMOVIDO: carregarHumores() na inicializa√ß√£o
      // Voc√™ pode criar um bot√£o espec√≠fico para "Carregar Hist√≥rico do Servidor" se precisar
    });

    console.log("‚úÖ Script de humor carregado com sucesso!");
  </script>

  <nav class="mobile-bottom-menu">
    <a href="home.html" class="mobile-menu-item" data-page="home">
      <img src="img/icons-menu/home.png" alt="Home">
    </a>

    <a href="banco.html" class="mobile-menu-item" data-page="banco">
      <img src="img/icons-menu/banco.png" alt="Banco">
    </a>

    <!-- Bot√£o Central - Redireciona para CVV -->
    <a href="https://www.cvv.org.br/" target="_blank" class="mobile-menu-item center-btn">
      <img src="img/icons-menu/sair.png" alt="CVV - Centro de Valoriza√ß√£o da Vida">
    </a>

    <a href="metricas.html" class="mobile-menu-item" data-page="metricas">
      <img src="img/icons-menu/metricas.png" alt="M√©tricas">
    </a>

    <a href="comunidade.html" class="mobile-menu-item" data-page="comunidade">
      <img src="img/icons-menu/comunidade.png" alt="Comunidade">
    </a>
  </nav>

  <!-- Script para marcar item ativo automaticamente -->
  <script>
    // Detecta a p√°gina atual e adiciona classe 'active'
    (function () {
      const currentPage = window.location.pathname.split('/').pop().replace('.html', '') || 'home';
      const menuItems = document.querySelectorAll('.mobile-menu-item[data-page]');

      menuItems.forEach(item => {
        const page = item.getAttribute('data-page');
        if (page === currentPage) {
          item.classList.add('active');
        }
      });
    })();
  </script>

</body>

</html>