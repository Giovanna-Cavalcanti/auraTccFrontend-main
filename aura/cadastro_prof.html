<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro Psicólogo - Aura</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/x-icon" href="img/logo-janela.png">
  <link rel="stylesheet" href="css/cadastro.css" />
  <style>
    .input-error {
      border-color: #ef4444 !important; /* Tailwind red-500 */
      box-shadow: 0 0 0 1px #ef4444 !important;
    }
    .input-custom {
      border: 1px solid #d1d5db; /* gray-300 */
      padding: 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .input-custom:focus {
      outline: none;
      border-color: #a3e635; /* lime-300 */
      box-shadow: 0 0 0 3px rgba(163, 230, 53, 0.4); /* soft shadow for focus */
    }
    .btn-submit {
        background-color: #758352; /* Cor de fundo principal */
        color: white;
        font-weight: bold;
        padding: 12px 24px;
        transition: background-color 0.2s;
    }
    .btn-submit:hover:not(:disabled) {
        background-color: #5d6840; /* Cor mais escura no hover */
    }
    .btn-submit:disabled {
        background-color: #a1a1aa; /* Cor cinza para desabilitado */
        cursor: not-allowed;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-50">
  <main class="max-w-6xl w-full bg-white rounded-xl overflow-hidden shadow-lg grid md:grid-cols-2 relative">

    <section class="flex flex-col p-6 md:p-12 justify-center gap-4">
      <header class="flex items-center gap-3 mb-4">
        <img 
          src="img/Logo.png" width="30px" height="30px"
          alt="Logo do AURA - Uma flor de lotus verde"
          onerror="this.onerror=null;this.src='https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/cbb07639-b571-4e20-96a1-0612aa286c2d.png';"
        />
        <span class="font-semibold text-xl select-none">AURA</span>
      </header>

      <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden">
        <div id="progress-bar" class="h-2 bg-[#758352] rounded-full transition-all duration-500 w-1/2"></div>
      </div>

      <h1 class="text-3xl font-extrabold leading-tight select-none">Crie uma conta</h1>
      <h2 class="text-gray-400 text-sm font-normal max-w-xs select-none md:max-w-full">
        Preencha os dados abaixo para criar sua conta.
      </h2>

      <form id="cadastroForm" class="flex flex-col gap-5 max-w-md w-full" novalidate>
        
        <div id="step1" class="flex flex-col gap-5">
          <label for="name" class="font-semibold text-sm select-none">Nome Completo</label>
          <input id="name" name="name" type="text" required autocomplete="name" class="input-custom" />
          
          <div class="flex flex-col md:flex-row gap-5">
            <div class="flex-grow">
              <label for="cpf" class="font-semibold text-sm select-none">CPF</label>
              <input id="cpf" name="cpf" type="text" maxlength="14" required autocomplete="off" class="input-custom" />
              <div id="cpf-feedback" class="text-xs mt-1"></div>
            </div>
            <div class="flex-grow">
              <label for="crp" class="font-semibold text-sm select-none">CRP</label>
              <input id="crp" name="crp" type="text" required autocomplete="off" class="input-custom" />
              <div id="crp-feedback" class="text-xs mt-1"></div>
            </div>
          </div> 

          <label for="email" class="font-semibold text-sm select-none">Email</label>
          <input id="email" name="email" type="email" required autocomplete="email" class="input-custom" />
          <div id="email-feedback" class="text-xs mt-1"></div>

          <div class="flex flex-col md:flex-row gap-5">
            <div class="flex-grow">
              <label for="password" class="font-semibold text-sm select-none">Senha</label>
              <input id="password" name="password" type="password" required autocomplete="new-password" class="input-custom" />
            </div>
            <div class="flex-grow">
              <label for="password-confirm" class="font-semibold text-sm select-none">Confirmação de Senha</label>
              <input id="password-confirm" name="password-confirm" type="password" required autocomplete="new-password" class="input-custom" />
            </div>
          </div>
          <div id="password-feedback" class="text-xs mt-1"></div>

          <button type="button" id="nextBtn" class="btn-submit w-full rounded-lg mt-4" aria-label="Botão para continuar">
            Continuar
          </button>
        </div>

        <div id="step2" class="flex flex-col gap-5 hidden">
          <label class="font-semibold text-sm select-none">Qual é o seu tipo de atuação?</label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="atuacao" value="clinica" class="accent-lime-400" required/> Atuação em Clínica
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="atuacao" value="atendimento próprio" class="accent-lime-400" required/> Atendimento próprio
            </label>
          </div>

          <label class="font-semibold text-sm select-none">Qual o valor da sua consulta?</label>
          <select name="valor" required class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-lime-400">
            <option value="" disabled selected>Selecione...</option>
            <option value="100-150">R$ 100 - R$ 150</option>
            <option value="200-250">R$ 200 - R$ 250</option>
            <option value="300-350">R$ 300 - R$ 350</option>
            <option value="400+">Acima de R$ 400</option>
          </select>

          <label class="font-semibold text-sm select-none">Quais convênios você atende? (Selecione um ou mais)</label>
          <div class="grid grid-cols-2 gap-3 p-3 border rounded-lg">
            <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="unimed" class="accent-lime-400"/> Unimed
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="bradesco" class="accent-lime-400"/> Bradesco Saúde
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="amil" class="accent-lime-400"/> Amil
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="sulamerica" class="accent-lime-400"/> SulAmérica
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="hapvida" class="accent-lime-400"/> Hapvida
            </label>
             <label class="flex items-center gap-2">
              <input type="checkbox" name="convenio" value="particular" class="accent-lime-400"/> Particular (Apenas)
            </label>
          </div>
          
          <label class="font-semibold text-sm select-none">Qual é a sua modalidade de atendimento?</label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" name="modalidade" value="online" class="accent-lime-400"/> Online
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="modalidade" value="presencial" class="accent-lime-400"/> Presencial
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="modalidade" value="hibrido" class="accent-lime-400"/> Híbrido
            </label>
          </div>

          <div class="flex justify-between gap-4">
            <button type="button" id="backBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg transition">
              Voltar
            </button>
            <button type="submit" class="btn-submit w-full text-white font-bold py-3 px-6 rounded-lg transition" aria-label="Cadastrar">
              Cadastrar
            </button>
          </div>
        </div>
      </form>

      <p class="text-sm text-gray-400 text-center mt-4">Já tem uma conta? 
        <a href="login_prof.html" class="forgot-link text-[#758352] hover:text-[#5d6840]">Login</a>
      </p>
    </section>

    <section id="img-section" class="hidden md:flex items-center justify-center p-12">
      <div class="relative w-full max-w-md rounded-xl overflow-hidden" aria-hidden="true">
        <img 
          src="img/cad e log/Image_cad_prof.png" 
          alt="Illustration showing a seated patient talking to a therapist via video call" 
          class="w-full h-auto rounded-xl object-cover" 
          onerror="this.style.display='none'"
        />
        <div class="left-bottom-text">Cadastro para <b>Profissionais de Psicologia</b></div>
      </div>
    </section>
  </main>

<script>
const BASE_URL = "https://auratccbackend.onrender.com/api/profissionais";

// =======================================================
// VARIÁVEIS E MÁSCARAS
// =======================================================

const cpfInput = document.getElementById("cpf");
const crpInput = document.getElementById("crp");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const passwordConfirmInput = document.getElementById("password-confirm");

const nextBtn = document.getElementById("nextBtn");
const step1 = document.getElementById("step1");
const step2 = document.getElementById("step2");
const progressBar = document.getElementById("progress-bar");
const form = document.getElementById("cadastroForm");

let emailValid = false;
let crpValid = false;

// =======================================================
// MÁSCARA CPF
// =======================================================
cpfInput.addEventListener("input", () => {
  let v = cpfInput.value.replace(/\D/g, "");
  if (v.length > 11) v = v.slice(0, 11);
  v = v.replace(/(\d{3})(\d)/, "$1.$2");
  v = v.replace(/(\d{3})(\d)/, "$1.$2");
  v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
  cpfInput.value = v;
});

// =======================================================
// VALIDAÇÃO MATEMÁTICA DO CPF
// =======================================================
function validateCPF(cpf) {
  const cpfClean = cpf.replace(/[^\d]+/g,''); 
  if(cpfClean.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(cpfClean)) return false;

  let sum = 0;
  let remainder;

  for (let i = 1; i <= 9; i++) {
    sum = sum + parseInt(cpfClean.substring(i - 1, i)) * (11 - i);
  }
  remainder = (sum * 10) % 11;

  if ((remainder === 10) || (remainder === 11)) remainder = 0;
  if (remainder !== parseInt(cpfClean.substring(9, 10))) return false;

  sum = 0;
  for (let i = 1; i <= 10; i++) {
    sum = sum + parseInt(cpfClean.substring(i - 1, i)) * (12 - i);
  }
  remainder = (sum * 10) % 11;

  if ((remainder === 10) || (remainder === 11)) remainder = 0;
  if (remainder !== parseInt(cpfClean.substring(10, 11))) return false;
  
  return true; 
}

// =======================================================
// FEEDBACK VISUAL GENÉRICO
// =======================================================
function setFeedback(elementId, message, type = 'error') {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.textContent = message;
  const inputEl = document.getElementById(elementId.replace('-feedback', ''));

  if (type === 'error') {
    el.className = 'text-red-500 text-xs mt-1';
    inputEl.classList.add('input-error');
  } else if (type === 'success') {
    el.className = 'text-green-600 text-xs mt-1';
    inputEl.classList.remove('input-error');
  } else {
    el.className = 'text-gray-500 text-xs mt-1';
    inputEl.classList.remove('input-error');
  }
}

function clearFeedback(elementId) {
  document.getElementById(elementId).textContent = '';
  document.getElementById(elementId.replace('-feedback', '')).classList.remove('input-error');
}

// =======================================================
// VALIDAÇÃO LOCAL DE EMAIL
// =======================================================
emailInput.addEventListener("input", () => {
  const email = emailInput.value.trim();
  if (!/\S+@\S+\.\S+/.test(email)) {
    setFeedback('email-feedback', 'Email inválido. Ex: nome@dominio.com', 'error');
    emailValid = false;
  } else {
    setFeedback('email-feedback', 'Email em formato válido.', 'success');
    emailValid = true;
  }
});
emailInput.addEventListener("blur", () => {
  if (!emailInput.value.trim()) clearFeedback('email-feedback');
});

// ---------------------------
// VALIDAÇÃO DE CRP (formato automático 12345/06)
// ---------------------------
crpInput.addEventListener("input", () => {
  let valor = crpInput.value.replace(/\D/g, ""); // mantém apenas números

  // Limita o número total de dígitos (5 + 2)
  if (valor.length > 7) valor = valor.slice(0, 7);

  // Adiciona a barra automaticamente após 5 dígitos
  if (valor.length > 5) {
    valor = valor.slice(0, 5) + "/" + valor.slice(5);
  }

  crpInput.value = valor;

  // Validação do formato final
  const regexCRP = /^\d{1,5}\/\d{2}$/; // ex: 12345/06
  if (regexCRP.test(valor)) {
    setFeedback("crp-feedback", "CRP válido.", "success");
    crpValid = true;
  } else {
    setFeedback("crp-feedback", "Formato inválido. Ex: 12345/06", "error");
    crpValid = false;
  }
});

crpInput.addEventListener("blur", () => {
  if (!crpInput.value.trim()) {
    clearFeedback("crp-feedback");
    crpValid = false;
  }
});


crpInput.addEventListener("blur", () => {
    if (!crpInput.value.trim()) {
        clearFeedback('crp-feedback');
        crpValid = false;
    }
});

// =======================================================
// VERIFICAÇÃO DE SENHA
// =======================================================
function checkPasswordMatch() {
  const senha = passwordInput.value;
  const confirmacaoSenha = passwordConfirmInput.value;
  
  if (!senha && !confirmacaoSenha) {
    clearFeedback('password-feedback');
    return false;
  }

  if (senha.length < 6) {
    setFeedback('password-feedback', 'A senha deve ter pelo menos 6 caracteres.', 'error');
    return false;
  }
  
  if (senha !== confirmacaoSenha) {
    setFeedback('password-feedback', 'As senhas não coincidem.', 'error');
    return false;
  } else {
    setFeedback('password-feedback', 'Senhas válidas.', 'success');
    return true;
  }
}
passwordInput.addEventListener('input', checkPasswordMatch);
passwordConfirmInput.addEventListener('input', checkPasswordMatch);

// =======================================================
// NAVEGAÇÃO ENTRE ETAPAS
// =======================================================
nextBtn.addEventListener("click", () => {
  const nomeCompleto = document.getElementById("name").value.trim();
  const cpfFormatado = cpfInput.value.trim();
  const senhaValida = checkPasswordMatch();

  if (!nomeCompleto || !cpfFormatado || !crpInput.value.trim() || !emailInput.value.trim() || !passwordInput.value || !passwordConfirmInput.value) {
    alert("⚠️ Preencha todos os campos obrigatórios da Etapa 1.");
    return;
  }

  if (!validateCPF(cpfFormatado)) {
    alert("⚠️ CPF inválido. Verifique o número.");
    cpfInput.classList.add('input-error');
    return;
  }

  if (!senhaValida || !crpValid || !emailValid) {
    alert("⚠️ Corrija os erros de validação (Email, CRP ou Senhas) antes de continuar.");
    return;
  }

  step1.classList.add("hidden");
  step2.classList.remove("hidden");
  progressBar.classList.add("w-full");
  progressBar.classList.remove("w-1/2");
});

document.getElementById("backBtn").addEventListener("click", () => {
  step2.classList.add("hidden");
  step1.classList.remove("hidden");
  progressBar.classList.add("w-1/2");
  progressBar.classList.remove("w-full");
});

// =======================================================
// SUBMIT FINAL (ENVIO PARA BACKEND)
// =======================================================
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const nomeCompleto = document.getElementById("name").value.trim();
  const cpfNumerico = cpfInput.value.replace(/\D/g, "");
  const crp = crpInput.value.trim();
  const email = emailInput.value.trim();
  const senha = passwordInput.value;

  const tipoAtuacao = document.querySelector('input[name="atuacao"]:checked')?.value;
  const valorConsulta = document.querySelector('select[name="valor"]').value;
  const convenios = Array.from(document.querySelectorAll('input[name="convenio"]:checked')).map(el => el.value);
  const modalidadesAtendimento = Array.from(document.querySelectorAll('input[name="modalidade"]:checked')).map(el => el.value);

  if (!tipoAtuacao || !valorConsulta) {
    alert("⚠️ Preencha todos os campos obrigatórios da Etapa 2!");
    return;
  }

  if (modalidadesAtendimento.length === 0) {
    alert("⚠️ Selecione pelo menos uma modalidade de atendimento.");
    return;
  }

  const payload = {
    nomeCompleto,
    cpf: cpfNumerico,
    crp,
    email,
    senha,
    tipoAtuacao,
    valorConsulta,
    convenios,
    modalidadesAtendimento
  };

  try {
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Cadastrando...';
    submitBtn.disabled = true;

    const response = await fetch(BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (response.ok) {
      alert("✅ Cadastro realizado com sucesso! Faça login para continuar.");
      window.location.href = "login_prof.html";
    } else {
      alert("❌ Erro no cadastro: " + (data.message || data.erro || JSON.stringify(data)));
    }
  } catch (error) {
    console.error("Erro de Rede:", error);
    alert("❌ Falha na conexão com o servidor. Tente novamente.");
  } finally {
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Cadastrar';
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>